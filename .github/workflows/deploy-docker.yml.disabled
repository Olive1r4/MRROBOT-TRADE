name: Deploy Docker para VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via Docker
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
      
      - name: üöÄ Deploy via SSH + Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            echo "============================================"
            echo "üê≥ DEPLOY DOCKER - BOT DE SCALPING"
            echo "============================================"
            
            # Navegar para o diret√≥rio
            cd ${{ secrets.VPS_PATH }}
            
            # Fazer backup do .env
            if [ -f .env ]; then
              echo "üíæ Fazendo backup do .env..."
              cp .env .env.backup
            fi
            
            # Atualizar c√≥digo
            echo "üì• Atualizando c√≥digo..."
            git fetch origin
            git reset --hard origin/main
            
            # Restaurar .env
            if [ -f .env.backup ]; then
              echo "‚ôªÔ∏è  Restaurando .env..."
              mv .env.backup .env
            fi
            
            # Verificar se Docker est√° instalado
            if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker n√£o est√° instalado!"
              exit 1
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "‚ùå Docker Compose n√£o est√° instalado!"
              exit 1
            fi
            
            echo "‚úÖ Docker e Docker Compose dispon√≠veis"
            
            # Parar container atual
            echo "‚è∏Ô∏è  Parando container atual..."
            docker-compose down || true
            
            # Remover imagem antiga (para garantir rebuild)
            echo "üóëÔ∏è  Removendo imagem antiga..."
            docker rmi mrrobot-scalping-bot_scalping-bot 2>/dev/null || true
            
            # Build da nova imagem
            echo "üî® Construindo nova imagem..."
            docker-compose build --no-cache
            
            # Iniciar novo container
            echo "üöÄ Iniciando novo container..."
            docker-compose up -d
            
            # Aguardar inicializa√ß√£o
            echo "‚è≥ Aguardando inicializa√ß√£o (30s)..."
            sleep 30
            
            # Verificar status
            echo "‚úÖ Verificando status..."
            docker-compose ps
            
            # Health check
            echo "üè• Testando health check..."
            WEBHOOK_PORT=$(grep "^WEBHOOK_PORT=" .env | cut -d'=' -f2 || echo "8000")
            
            if curl -f -s http://localhost:${WEBHOOK_PORT}/health > /dev/null 2>&1; then
              echo "‚úÖ Health check OK!"
            else
              echo "‚ö†Ô∏è  Health check falhou, verificando logs..."
              docker-compose logs --tail=50
              exit 1
            fi
            
            # Limpar imagens antigas
            echo "üßπ Limpando imagens antigas..."
            docker image prune -f
            
            echo "============================================"
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo "============================================"
            
            # Exibir informa√ß√µes
            echo ""
            echo "üìä Status do container:"
            docker-compose ps
            
            echo ""
            echo "üíæ Uso de recursos:"
            docker stats --no-stream $(docker-compose ps -q) || true
            
            echo ""
            echo "üìù √öltimas linhas de log:"
            docker-compose logs --tail=10
      
      - name: üîî Notificar sucesso
        if: success()
        run: |
          echo "‚úÖ Deploy Docker realizado com sucesso!"
          echo "üåê Bot dispon√≠vel em: http://${{ secrets.VPS_HOST }}:8000"
      
      - name: ‚ùå Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy Docker falhou! Verifique os logs acima."

# ============================================
# CONFIGURA√á√ÉO DOS SECRETS NO GITHUB
# ============================================
# 
# V√° em: Settings > Secrets and variables > Actions
# 
# Adicione os seguintes secrets:
# 
# 1. VPS_SSH_KEY
#    Conte√∫do: Chave privada SSH completa
# 
# 2. VPS_HOST
#    Exemplo: 192.168.1.100 ou seu.dominio.com
# 
# 3. VPS_USER
#    Exemplo: ubuntu ou seu usu√°rio da VPS
# 
# 4. VPS_PATH
#    Exemplo: /home/ubuntu/MRROBOT-FUTURE
# 
# ============================================
# PREPARA√á√ÉO DA VPS
# ============================================
# 
# 1. Instale Docker:
#    curl -fsSL https://get.docker.com | sh
#    sudo usermod -aG docker $USER
# 
# 2. Instale Docker Compose:
#    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
#    sudo chmod +x /usr/local/bin/docker-compose
# 
# 3. Clone o reposit√≥rio
# 4. Configure o .env
# 5. Adicione chave SSH do GitHub Actions ao authorized_keys
# 
# ============================================
