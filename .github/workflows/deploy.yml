name: Deploy Bot de Scalping para VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para VPS via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
      
      - name: üîê Configurar chave SSH
        run: |
          mkdir -p ~/.ssh
          # Salvar chave (garantindo formato correto)
          printf "%s" "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Adicionar host aos known_hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # Verificar se a chave est√° v√°lida
          ssh-keygen -l -f ~/.ssh/id_ed25519 || echo "‚ö†Ô∏è Aviso: formato de chave pode estar incorreto"
      
      - name: üöÄ Deploy via SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            echo "============================================"
            echo "ü§ñ INICIANDO DEPLOY DO BOT DE SCALPING"
            echo "============================================"
            
            # Navegar para o diret√≥rio do projeto
            cd ${{ secrets.VPS_PATH }}
            
            # Fazer backup do arquivo .env
            if [ -f .env ]; then
              echo "üíæ Fazendo backup do .env..."
              cp .env .env.backup
            fi
            
            # Atualizar c√≥digo do reposit√≥rio
            echo "üì• Atualizando c√≥digo..."
            git fetch origin
            git reset --hard origin/main
            
            # Restaurar arquivo .env
            if [ -f .env.backup ]; then
              echo "‚ôªÔ∏è  Restaurando .env..."
              mv .env.backup .env
            fi
            
            # Parar containers
            echo "‚è∏Ô∏è  Parando containers..."
            docker compose down || true
            
            # Build nova imagem
            echo "üî® Construindo nova imagem..."
            docker compose build --no-cache
            
            # Iniciar containers
            echo "üöÄ Iniciando containers..."
            docker compose up -d
            
            # Aguardar inicializa√ß√£o
            echo "‚è≥ Aguardando inicializa√ß√£o..."
            sleep 15
            
            # Verificar status
            echo "‚úÖ Verificando status dos containers..."
            docker compose ps
            
            # Exibir logs
            echo "üìã √öltimas linhas de log:"
            docker compose logs --tail=20
            
            echo "============================================"
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo "============================================"
          ENDSSH
      
      - name: üìä Verificar sa√∫de da aplica√ß√£o
        run: |
          sleep 5
          curl -f http://${{ secrets.VPS_HOST }}:8000/health || echo "‚ö†Ô∏è Health check falhou"
      
      - name: üîî Notificar sucesso
        if: success()
        run: |
          echo "‚úÖ Deploy realizado com sucesso!"
          echo "üåê Aplica√ß√£o dispon√≠vel em: http://${{ secrets.VPS_HOST }}:8000"
      
      - name: ‚ùå Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy falhou! Verifique os logs acima."

# ============================================
# CONFIGURA√á√ÉO DOS SECRETS NO GITHUB
# ============================================
# 
# V√° em: Settings > Secrets and variables > Actions > New repository secret
# 
# Adicione os seguintes secrets:
# 
# 1. VPS_SSH_KEY
#    Conte√∫do: Chave privada SSH (arquivo ~/.ssh/id_rsa do seu computador)
#    Para gerar: ssh-keygen -t rsa -b 4096 -C "github-actions"
#    Cole o conte√∫do completo do arquivo, incluindo:
#    -----BEGIN OPENSSH PRIVATE KEY-----
#    ...
#    -----END OPENSSH PRIVATE KEY-----
# 
# 2. VPS_HOST
#    Exemplo: 192.168.1.100 ou seu.dominio.com
# 
# 3. VPS_USER
#    Exemplo: ubuntu ou seu usu√°rio da VPS
# 
# 4. VPS_PATH
#    Exemplo: /home/ubuntu/MRROBOT-FUTURE
# 
# ============================================
# CONFIGURA√á√ÉO DA VPS
# ============================================
# 
# Na sua VPS, adicione a chave p√∫blica SSH do GitHub Actions:
# 
# 1. Copie a chave P√öBLICA (arquivo .pub gerado junto com a privada)
# 
# 2. Na VPS, execute:
#    mkdir -p ~/.ssh
#    echo "sua_chave_publica_aqui" >> ~/.ssh/authorized_keys
#    chmod 700 ~/.ssh
#    chmod 600 ~/.ssh/authorized_keys
# 
# 3. Configure o usu√°rio para usar sudo sem senha (apenas para systemctl):
#    sudo visudo
#    Adicione a linha:
#    ubuntu ALL=(ALL) NOPASSWD: /bin/systemctl start scalping-bot, /bin/systemctl stop scalping-bot, /bin/systemctl restart scalping-bot, /bin/systemctl status scalping-bot
# 
# ============================================
