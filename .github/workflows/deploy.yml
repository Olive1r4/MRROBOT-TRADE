name: Deploy Bot de Scalping para VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy para VPS via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ” Configurar chave SSH
        run: |
          mkdir -p ~/.ssh
          # Decodificar chave base64 e salvar
          echo "${{ secrets.VPS_SSH_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Adicionar host aos known_hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # Verificar se a chave estÃ¡ vÃ¡lida
          echo "âœ… Verificando chave SSH..."
          ssh-keygen -l -f ~/.ssh/id_ed25519
      
      - name: ðŸš€ Deploy via SSH
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -s "${{ secrets.VPS_PATH }}" << 'ENDSSH'
            set -e
            
            VPS_PATH="$1"
            
            echo "============================================"
            echo "ðŸ¤– INICIANDO DEPLOY DO BOT DE SCALPING"
            echo "============================================"
            echo "ðŸ“‚ DiretÃ³rio alvo: $VPS_PATH"
            
            # Verificar se o diretÃ³rio existe
            if [ ! -d "$VPS_PATH" ]; then
              echo "ðŸ“ Criando diretÃ³rio do projeto..."
              mkdir -p "$VPS_PATH"
            fi
            
            # Navegar para o diretÃ³rio do projeto
            cd "$VPS_PATH"
            
            # Verificar se Ã© um repositÃ³rio Git
            if [ ! -d .git ]; then
              echo "ðŸ”§ Inicializando repositÃ³rio Git..."
              git init
            fi
            
            # Configurar safe.directory para evitar erro de ownership
            echo "ðŸ” Configurando safe.directory..."
            git config --global --add safe.directory "$VPS_PATH"
            
            # Verificar se remote origin existe e configurar
            if ! git remote | grep -q "^origin$"; then
              echo "ðŸ”— Adicionando remote origin..."
              git remote add origin https://github.com/Olive1r4/MRROBOT-FUTURE.git
            fi
            
            # Fazer backup do arquivo .env
            if [ -f .env ]; then
              echo "ðŸ’¾ Fazendo backup do .env..."
              cp .env .env.backup
            fi
            
            # Atualizar cÃ³digo do repositÃ³rio
            echo "ðŸ“¥ Atualizando cÃ³digo..."
            git fetch origin
            git reset --hard origin/main
            
            # Restaurar arquivo .env
            if [ -f .env.backup ]; then
              echo "â™»ï¸  Restaurando .env..."
              mv .env.backup .env
            fi
            
            # Parar containers
            echo "â¸ï¸  Parando containers..."
            docker compose down || true
            
            # Build nova imagem
            echo "ðŸ”¨ Construindo nova imagem..."
            docker compose build --no-cache
            
            # Iniciar containers
            echo "ðŸš€ Iniciando containers..."
            docker compose up -d
            
            # Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 15
            
            # Verificar status
            echo "âœ… Verificando status dos containers..."
            docker compose ps
            
            # Exibir logs
            echo "ðŸ“‹ Ãšltimas linhas de log:"
            docker compose logs --tail=20
            
            echo "============================================"
            echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
            echo "============================================"
          ENDSSH
      
      - name: ðŸ“Š Verificar saÃºde da aplicaÃ§Ã£o
        run: |
          sleep 5
          curl -f http://${{ secrets.VPS_HOST }}:8000/health || echo "âš ï¸ Health check falhou"
      
      - name: ðŸ”” Notificar sucesso
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ðŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://${{ secrets.VPS_HOST }}:8000"
      
      - name: âŒ Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."

# ============================================
# CONFIGURAÃ‡ÃƒO DOS SECRETS NO GITHUB
# ============================================
# 
# VÃ¡ em: Settings > Secrets and variables > Actions > New repository secret
# 
# Adicione os seguintes secrets:
# 
# 1. VPS_SSH_KEY
#    ConteÃºdo: Chave privada SSH (arquivo ~/.ssh/id_rsa do seu computador)
#    Para gerar: ssh-keygen -t rsa -b 4096 -C "github-actions"
#    Cole o conteÃºdo completo do arquivo, incluindo:
#    -----BEGIN OPENSSH PRIVATE KEY-----
#    ...
#    -----END OPENSSH PRIVATE KEY-----
# 
# 2. VPS_HOST
#    Exemplo: 192.168.1.100 ou seu.dominio.com
# 
# 3. VPS_USER
#    Exemplo: ubuntu ou seu usuÃ¡rio da VPS
# 
# 4. VPS_PATH
#    Exemplo: /home/ubuntu/MRROBOT-FUTURE
# 
# ============================================
# CONFIGURAÃ‡ÃƒO DA VPS
# ============================================
# 
# Na sua VPS, adicione a chave pÃºblica SSH do GitHub Actions:
# 
# 1. Copie a chave PÃšBLICA (arquivo .pub gerado junto com a privada)
# 
# 2. Na VPS, execute:
#    mkdir -p ~/.ssh
#    echo "sua_chave_publica_aqui" >> ~/.ssh/authorized_keys
#    chmod 700 ~/.ssh
#    chmod 600 ~/.ssh/authorized_keys
# 
# 3. Configure o usuÃ¡rio para usar sudo sem senha (apenas para systemctl):
#    sudo visudo
#    Adicione a linha:
#    ubuntu ALL=(ALL) NOPASSWD: /bin/systemctl start scalping-bot, /bin/systemctl stop scalping-bot, /bin/systemctl restart scalping-bot, /bin/systemctl status scalping-bot
# 
# ============================================
